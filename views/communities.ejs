<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communities - G24Sec</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/communities.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/theme.js"></script>
</head>
<body class="light-mode">
    <%- include('partials/navbar') %>

    <div class="main-container">
        <div class="communities-header">
            <h1>Communities</h1>
            <button id="create-community-btn" class="btn primary-btn">Create Community</button>
        </div>

        <div class="communities-grid">
            <% if (communities && communities.length > 0) { %>
                <% communities.forEach(community => { %>
                    <div class="community-card">
                        <div class="community-card-header">
                            <% if (community.icon) { %>
                                <img src="<%= community.icon %>" alt="<%= community.displayName %>" class="community-icon">
                            <% } else { %>
                                <div class="community-icon-placeholder">
                                    <%= community.displayName.charAt(0).toUpperCase() %>
                                </div>
                            <% } %>
                            <h3 class="community-name">
                                <a href="/communities/<%= community.name %>"><%= community.displayName %></a>
                            </h3>
                            <% if (community.isPrivate) { %>
                                <span class="community-privacy"><i class="fas fa-lock"></i></span>
                            <% } %>
                        </div>
                        <div class="community-description">
                            <%= community.description || 'No description available' %>
                        </div>
                        <div class="community-footer">
                            <span class="community-creator">
                                Created by 
                                <a href="/profile/<%= community.creator.username %>">
                                    <%= community.creator.username %>
                                </a>
                            </span>
                            <a href="/communities/<%= community.name %>" class="btn secondary-btn">View</a>
                        </div>
                    </div>
                <% }) %>
            <% } else { %>
                <div class="no-communities">
                    <p>No communities found. Be the first to create one!</p>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Create Community Modal -->
    <div id="create-community-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Create a New Community</h2>
            <form id="create-community-form">
                <div class="form-group">
                    <label for="name">Community Name (URL-friendly, no spaces)</label>
                    <input type="text" id="name" name="name" required pattern="^[a-zA-Z0-9_-]+$" 
                           title="Only letters, numbers, underscores, and dashes are allowed">
                    <small>This will be used in the URL: communities/your-community-name</small>
                </div>
                <div class="form-group">
                    <label for="displayName">Display Name</label>
                    <input type="text" id="displayName" name="displayName" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="rules">Community Rules</label>
                    <textarea id="rules" name="rules" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="isPrivate">Privacy</label>
                    <select id="isPrivate" name="isPrivate">
                        <option value="false">Public - Anyone can view and join</option>
                        <option value="true">Private - Only members can view posts</option>
                    </select>
                </div>
                <button type="submit" class="btn primary-btn">Create Community</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('create-community-modal');
            const btn = document.getElementById('create-community-btn');
            const closeBtn = document.getElementsByClassName('close')[0];
            const form = document.getElementById('create-community-form');
            
            // Open modal
            btn.onclick = function() {
                modal.style.display = 'block';
            }
            
            // Close modal
            closeBtn.onclick = function() {
                modal.style.display = 'none';
            }
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
            
            // Handle form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    name: document.getElementById('name').value,
                    displayName: document.getElementById('displayName').value,
                    description: document.getElementById('description').value,
                    rules: document.getElementById('rules').value,
                    isPrivate: document.getElementById('isPrivate').value
                };
                
                try {
                    const response = await fetch('/communities/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert('Community created successfully!');
                        window.location.href = `/communities/${formData.name}`;
                    } else {
                        alert(`Error: ${result.message}`);
                    }
                } catch (error) {
                    console.error('Error creating community:', error);
                    alert('An error occurred while creating the community.');
                }
            });
        });
    </script>
</body>
</html>
